---
title: "Week 1 2022 Recap"
author: "Samuel Kirschner"
date: "9/12/2022"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ffscrapr)
library(dplyr)
library(ggplot2)
library(gt)
library(sqldf)
library(gtExtras)
library(tidymodels)
library(tidyr)
library(DBI)
library(ggimage)
remotes::install_github("jthomasmock/espnscrapeR")
library(espnscrapeR)



#### INPUT WHAT WEEK IT IS HERE ####
week_num<-1

swid<-"{FB82F2B3-89EB-4E1A-9677-B1333054B883}"

ESPN_S2<-"AECkrDCmS9dG4sssE55%2BNQRasW7jwjJVFyEUw6mR2wLFylIkvGy89sVJxc8GMvORMKJaBksVZfGnYB4BXKiM80pkw352zpsk%2BEbMg2ILadghIeMp2iz1Etpke3FMM2pyVdNg23edB2DoYIHMoUT72KS3Ho9bKNLPkkJ761JMh4o4ikTDTeL1uBJYNiahAMg1uvT4mHvszAP1UoDHQGLUPuOLchpl8Os8BsibtvBOTn778ksyx6gU513HRQGrpge7iQ9G04xOeWwYAjXfwcxa%2FCQr3Gx9kECPmidN9%2F7PrHImFQ%3D%3D"

espn_conn_2022 <- espn_connect(
  season = 2022,
  league_id = 214888,
  espn_s2 = ESPN_S2,
  swid = swid
)

kfl_schedule_2021<-ff_schedule(espn_conn_2022)
kfl_pscores<-ff_playerscores(espn_conn_2022)
starters<-ff_starters(espn_conn_2022)


kfl_franchises_2021<-ff_franchises(espn_conn_2022)
#kfl_franchises_2021$logo[10]<-"https://image.shutterstock.com/image-vector/lightning-warrior-logo-template-design-260nw-1019248687.jpg"
kfl_franchises_2021$logo[3]<-"https://www.pngkit.com/png/detail/269-2691865_winners-logo-winners.png"

kfl_db <-"kfl_ff_data" 
host_db <- "localhost"
db_port <- "5432"
db_user <- "postgres"  
db_password <- "Cincinnati1"
kfl_con <- dbConnect(RPostgres::Postgres(), dbname = kfl_db, host=host_db, port=db_port, user=db_user, password=db_password)   

kfl_schedule<-dbReadTable(kfl_con,"kfl_schedule")
kfl_franchises<-dbReadTable(kfl_con,"kfl_franchise")

```
## Week 1 Recap

Nothing like a first week bloodbath in toughest division in the KFL with the first and second highest scoring teams playing one another. A tough break for the Cincinnati Monarchs putting up above 100 points and taking the L. Sometimes we overthink things in this league, but in the KFL the quarterback still reigns and Patrick Mahomes 44 points would have handed the Tenderloins a loss all by themselves. 

The Kraken get off to a hot start and look to be a force to be reckoned with yet again, but playing against an historical bad Tenderloin team made the 98 points a bit excessive. We had a couple of basement scraps with The Bluecats and Ducks scoring below 80 and still coming home with the dub, and Elliot's Last Good Tight End and Scott's Titans took the win in the Glum division.

```{r wins over expected model run, echo=FALSE}



score_distribution_data<-sqldf(
"select a.franchise_id,b.user_name,a.Years,a.week,franchise_score as score_for, opponent_score as score_against
 from kfl_schedule a
 left outer join kfl_franchises b 
 on a.franchise_id = b.franchise_id and a.Years = b.Years
 where week < 15"
)

score_distribution_data<-score_distribution_data%>%unite(YR_WK, c("Years","week"),remove = FALSE)

score_distribution_data<-score_distribution_data%>%group_by(YR_WK)%>%mutate(avg_weekly_score=mean(score_for),win = case_when(score_for > score_against ~ 1,score_for < score_against ~ 0))

score_distribution_data$win<-as.factor(score_distribution_data$win)

fitted_logistic_model<- logistic_reg() %>%
        # Set the engine
        set_engine("glm") %>%
        # Set the mode
        set_mode("classification") %>%
        # Fit the model
        fit(win~score_for, data = score_distribution_data)

```

```{r wins over expected model, echo=FALSE,warning=FALSE}
## 2021 win probs

kfl_2021_win_prob_data<-kfl_schedule_2021%>%rename( score_for = franchise_score)%>%filter(week<=week_num)

pred_prob_2021 <- predict(fitted_logistic_model,
                          new_data = kfl_2021_win_prob_data,
                          type = "prob")

colnames(pred_prob_2021)<-c("loss_prob", "win_prob")

kfl_2021_win_prob_data<-cbind(kfl_2021_win_prob_data,pred_prob_2021)

kfl_2021_win_prob_data<-kfl_2021_win_prob_data%>%mutate(win = case_when(score_for > opponent_score ~ 1,score_for < opponent_score ~ 0))

kfl_2021_win_prob_data[37,9]<-1
kfl_2021_win_prob_data[40,9]<-0
kfl_2021_win_prob_data[39,9]<-1
kfl_2021_win_prob_data[44,9]<-0


kfl_2021_weekly_data<-sqldf("SELECT A.*,B.franchise_name,B.franchise_abbrev,B.logo,C.franchise_name as opponent_franchise,C.franchise_abbrev as opponent_abbrev,C.logo as opponent_logo
      FROM kfl_2021_win_prob_data A
      LEFT OUTER JOIN kfl_franchises_2021 B
      on a.franchise_id = b.franchise_id
      LEFT OUTER JOIN kfl_franchises_2021 C
      on a.opponent_id = c.franchise_id")
```

```{r wk4 review, echo=FALSE,warning=FALSE,,message=FALSE}

wk4_matchups<-kfl_2021_weekly_data%>%filter(week==week_num &win==1)


############################## UPDATE THE WEEK #####################################################
wk4_matchups<-sqldf("select A.*,B.win_prob as opp_win_prob
                    FROM wk4_matchups A
                    LEFT OUTER JOIN kfl_2021_weekly_data B
                    ON A.opponent_id=B.franchise_id
                    WHERE B.week = 1")

wk4_matchups<-wk4_matchups%>%select(franchise_name,logo,win_prob,score_for,opponent_score,opp_win_prob,opponent_logo,opponent_franchise)


########################## UPDATE THE TITLE OF THE TAB HEADER #######################################
wk4_matchups%>%mutate(win_prob=round(win_prob,2),opp_win_prob=round(opp_win_prob,2))%>%gt()%>%gt_img_rows(logo)%>%gt_img_rows(opponent_logo)%>%
  tab_header(title ="Week 1 2022 matchups")%>%
  cols_label(franchise_name="Winning Team",logo="",win_prob= "Win Probability",score_for="Score",opponent_score="Score",opp_win_prob="Win Probability",opponent_logo="",opponent_franchise="Losing Team")%>%
  tab_style(
    style = list(
      cell_borders(
        sides = "left",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = vars(opponent_score)
      )
    )
  ) %>%
  # We use tab_style() to change style of cells
  # cell_borders() provides the formatting
  # locations tells it where
  # Add black borders to the bottom of all the column labels
  tab_style(
    style = list(
      cell_borders(
        sides = "bottom",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_column_labels(
        columns = gt::everything()
      )
    )
  )%>%
   data_color(
    columns = vars(score_for),
    colors = scales::col_numeric(
      palette = c("#c9ecb4"),
      domain = NULL
    ))%>%
   data_color(
    columns = vars(win_prob),
    colors = scales::col_numeric(
      palette = c("#ffffff", "#f2fbd2", "#c9ecb4", "#93d3ab", "#35b0ab"),
      domain = NULL
    ))%>%
   data_color(
    columns = vars(opponent_score),
    colors = scales::col_numeric(
      palette = c("#EF9A9AFF"),
      domain = NULL
    ))%>%
   data_color(
    columns = vars(opp_win_prob),
    colors = scales::col_numeric(
      # Using a function from paletteer to generate a vector of colors
      # Note that you need to wrap paletteer_d outputs in as.character()
      palette = as.character(paletteer::paletteer_d("ggsci::red_material", n = 5)),
      # Domain is from scales::col_numeric
      # Domain = The possible values that can be mapped
      # We don't HAVE to set a range for this since
      # we're using it inside data_color()
      domain = NULL
    ))

```

## Expected Wins power rankings through week 1 2022

The Monarchs had an 80% win probability with the points they put up, but came up unlucky facing a stiff opponent and start with -0.80 Wins over expected.  They look to be a tough opponent going forward. On the opposite end of the spectrum, The Tenderloins start out with a 0.01 Expected wins so there is only up to go from here. The Bluecats are looking to be the lucky team right now with 0.66 wins over expected.

```{r expected_wins, echo=FALSE,warning=FALSE,fig.width = 10,fig.height=8,message=FALSE}
kfl_wins_over_expected<-kfl_2021_weekly_data%>%select(win_prob,win,franchise_id,franchise_name,logo,franchise_abbrev)%>%group_by(franchise_id,franchise_name,franchise_abbrev,logo)%>%summarise(expected_wins = sum(win_prob),wins = sum(win))%>%mutate(wins_over_expected = wins - expected_wins)%>%arrange(expected_wins)%>%na.omit()

week_4_table<-kfl_wins_over_expected%>%select(franchise_id,franchise_name,franchise_abbrev,logo,wins,expected_wins,wins_over_expected)%>%mutate(expected_wins = round(expected_wins,2), wins_over_expected = round(wins_over_expected,2))%>%arrange(desc(expected_wins))

week_4_table<-as.data.frame(week_4_table[,c(2:7)])%>%na.omit()

asp_ratio <- 1.618 


################### UPDATE PLOT TITLE ##############################
week4_exp_wins<-ggplot(kfl_wins_over_expected,aes(x=reorder(franchise_abbrev,expected_wins),y=expected_wins))+geom_bar(stat="identity")+geom_image(aes(x=franchise_abbrev,y=expected_wins,image=logo), size = 0.05, by = "width", asp = asp_ratio
)+coord_flip()+ggtitle("Expected Wins through Week 1") + xlab("franchise") + ylab("expected wins")+theme(axis.title.x = element_text(size=14),axis.title.y=element_text(size=14),axis.text = element_text(size = 12),plot.title = element_text(size = 18))

week4_exp_wins

################### UPDATE TABLE TITLE ##############################
week_4_table%>%select(franchise_name,logo,expected_wins,wins_over_expected)%>%gt()%>%gt_img_rows(logo) %>%tab_header(title ="Expected Wins through Week 1")%>%
  cols_label(franchise_name="Team Name",logo="",expected_wins="Expected Wins",wins_over_expected="Wins Over Expected")


#theme(aspect.ratio = 1/asp_ratio)

# include aspect ratio in ggsave
#ggsave(
#  "week4_exp_wins.png", week4_exp_wins, 
#  # make the width equivalent to the aspect.ratio
#  height = 20, width = 20 * asp_ratio, dpi = "retina"
#)






```
## Standings through Week 1



```{r divison records, echo=FALSE,warning=FALSE,fig.width = 10,fig.height=8,message=FALSE}

kfl_standings_wk4<-kfl_2021_weekly_data%>%filter(week<=week_num)

franchise_id<-1:12
division_name<-c("Ohio","Glum","Ohio","Indiana","Glum","Ohio","Ohio","Indiana","Indiana","Glum","Glum","Indiana")
kfl_division<-as.data.frame(cbind(franchise_id,division_name))
kfl_division$franchise_id<-as.numeric(kfl_division$franchise_id)


kfl_division_data<- sqldf("Select A.*,B.division_name
      from kfl_standings_wk4 A
      left outer join kfl_division B
      on A.Franchise_ID = B.Franchise_ID
      ")

team_df<-kfl_division_data%>%filter(week == 1)%>%select(franchise_id,franchise_name,logo,division_name)

joined_df<-kfl_division_data%>%select(franchise_id,franchise_name,logo,division_name,win)%>%group_by(franchise_name,franchise_id)%>%summarise(
         Wins = length(win[win==1]),
         Losses = length(win[win==0]),
         outcomes = list(win), .groups = "drop") %>% 
     left_join(team_df, by = c("franchise_id" = "franchise_id","franchise_name"="franchise_name")) %>% 
     select(logo,franchise_name, division_name, Wins:outcomes)
 

###################### NEED TO UPDATE THE TITLE HEADER FOR WEEK  ##########################
standings_df<-joined_df%>%select(franchise_name,logo,division_name,Wins,Losses,outcomes)%>%arrange(desc(Wins))%>%gt(groupname_col="division_name")%>%gt_plt_winloss(outcomes,max_wins = 14)%>%gt_img_rows(logo)%>%tab_header(title ="Standings Through Week 5")%>%cols_label(franchise_name="Team",logo="",outcomes="Win-Loss Streak")

standings_df

```
```{r bench depth, echo=FALSE,warning=FALSE,fig.width = 10,fig.height=8,message=FALSE}

graph_data = starters%>%mutate(lineup_slot = ifelse(lineup_slot == 'RB/WR',pos,lineup_slot))%>%filter(week==week_num)%>%select(franchise_name,lineup_slot,player_score)%>%group_by(franchise_name,lineup_slot)%>%mutate(position_scoring = sum(player_score))%>%select(-player_score)%>%distinct()
```

## Studs and Duds

A new feature this year will be the Stud and Dud of the week. I will highlight the players that disappointed the most or put up an unlikely performance and peformed well over expectation (according to ESPN projections). Other new features to come in following weeks, but I've been banging away at this laptop for too long. Enjoy.

## Stud of the Week

I refuse to comment on this. 


```{r stud, echo=FALSE,warning=FALSE,fig.width = 10,fig.height=8,message=FALSE}
team_df <- espnscrapeR::get_nfl_teams() %>% 
  select(team = team_abb, logo)

exclude_pos <-c('BE','DST')

stud<-starters%>%filter(lineup_slot != exclude_pos)%>%mutate(proj_diff=player_score-projected_score)%>%slice_max(proj_diff)%>%select(franchise_name,player_name,team,player_score,projected_score,proj_diff)
dud<-starters%>%filter(lineup_slot != exclude_pos)%>%mutate(proj_diff=player_score-projected_score)%>%slice_min(proj_diff)%>%select(franchise_name,player_name,team,player_score,projected_score,proj_diff)

dud<-dud%>%inner_join(team_df,by=c('team'='team'))
stud<-stud%>%inner_join(team_df,by=c('team'='team'))

stud_table <- stud%>%select(franchise_name,player_name,logo,team,player_score,projected_score,proj_diff) %>%
  gt() %>%
  text_transform(
      locations = cells_body(
        vars(logo)
      ),
      fn = function(x) {
        web_image(
          url = x,
          height = 25
        )
      })%>%
   cols_label(
      franchise_name = "KFL Team",
      player_name = "player",
      logo = "",
      team = "Team",
      player_score = "actual score",
      projected_score = "projection",
      proj_diff = "difference"
    )
stud_table

```
## Dud of the Week

Dud of the week goes to Cowboys Quarterback Dak Prescott. We love to kick a guy while he is down and while this is partially due to his injury, Dak and the Cowboys office looked putrid. Those with stock in Cowboys players should be worried because they look like they may be one of the worst teams in the league. Dak gets the inaugural dud of the week and gets a nice long break as Cooper Rush takes his job after going for 300 yards and 4 touchdowns against the Bengals next week. 

```{r dud, echo=FALSE,warning=FALSE,fig.width = 10,fig.height=8,message=FALSE}
dud_table <- dud%>%select(franchise_name,player_name,logo,team,player_score,projected_score,proj_diff) %>%
  gt() %>%
  text_transform(
      locations = cells_body(
        vars(logo)
      ),
      fn = function(x) {
        web_image(
          url = x,
          height = 25
        )
      })%>%
   cols_label(
      franchise_name = "KFL Team",
      player_name = "player",
      logo = "",
      team = "Team",
      player_score = "actual score",
      projected_score = "projection",
      proj_diff = "difference"
    )
dud_table

```